---
layout: post
title: üá™üá∏ Unpacking VMProtect 3.x
author: voidm4p
date: 2022-02-03 09:00:00
categories:
- malware
tags:
- vmprotect
- unpacking
- windows
toc: true
---
# Desempaquetando VMProtect 3.X 
 
<a href="https://vmpsoft.com/" target=_blank>VMProtect</a>, tambi√©n abreviado VMP, es un conocido software de protecci√≥n para programas Windows que incluye gran cantidad de t√©cnicas sofisticadas como mutaci√≥n y virtualizaci√≥n de c√≥digo las cuales dificultan tremendamente la tarea de realizar ingenier√≠a inversa sobre un software que cuenta con esta protecci√≥n. 
 
Dadas las grandes ventajas que aporta en cuanto a protecci√≥n, a lo largo de los a√±os no solo ha atra√≠do la atenci√≥n de las compa√±√≠as de desarrollo de software, sino que tambi√©n se ha vuelto bastante popular su uso entre los desarrolladores de *malware*. No obstante, al tratarse de un software comercial, normalmente √©stos optan por utilizar versiones pirateadas y, debido tambi√©n a su inexperiencia con el uso de la herramienta, no llegan a configurarla correctamente para aplicar las protecciones m√°s avanz adas de mutaci√≥n y/o virtualizaci√≥n, como en el caso del reciente ransomware Night Sky. 
 
Independientemente de que se apliquen estas ofuscaciones, todos los binarios protegidos por VMProtect son protegidos por un empaquetador propio que, adem√°s, permite la opci√≥n de ofuscar las llamadas a la API declaradas en la tabla de importaciones del binario original. 
 
Este art√≠culo describe el procedimiento de desempaquetado para binarios protegidos mediante VMProtect sin centrarse, por ahora, en la protecci√≥n mediante virtualizaci√≥n y/o mutaci√≥n, que se trata de un proceso completamente diferente y mucho m√°s costoso de superar. 
 
![Image 1](/assets/img/posts/vmprotect-2022/img01_01.jpg)
<p style="text-align:center;margin-top: -30px;">Ventana de configuraci√≥n de VMProtect</p>

Empaquetar un binario consiste en comprimir y/o cifrar sus secciones. En el caso de VMProtect, las secciones originales son sustituidas y todo el fichero original es condensado en una secci√≥n que contiene en formato cifrado las secciones originales, las rutinas para su descifrado y otras informaciones de inter√©s sobre las secciones. Esta nueva secci√≥n recibe el nombre de ".vmp1" por defecto. 

![Image 2](/assets/img/posts/vmprotect-2022/img01_02.png)
<p style="text-align:center;margin-top: -30px;">Secciones de un binario "Hello World" antes y despu√©s de ser empaquetado con VMProtect</p>

Tras cargar el binario empaquetado en el debugger se observa que, salvo la secci√≥n .data, ninguna tiene permisos de lectura. Por lo que, si el binario desea extraer la informaci√≥n original, deber√° de cambiar los permisos de √©stas para as√≠ poder escribir sobre ellas y sustituir su contenido. 
 
Para conseguir √©sto, existen API de Windows como `VirtualProtect`. Sin embargo, VMProtect ha decidido hacer uso de una API similar pero de m√°s bajo nivel y menos documentada como lo es `ZwProtectVirtualMemory`. 
 
Para comenzar el proceso de desempaquetado es necesario llegar al Entry Point del binario empaquetado que es completamente diferente al del original. De hecho, esta rutina se encuentra virtualizada por lo que resulta pr√°cticamente imposible distinguir su funcionalidad observando los opcodes que identifique cualquier desensamblador. 
 
Teniendo en cuenta que se van a realizar diversas llamadas a la API mencionada, se establecer√°, a partir de aqu√≠, un punto de interrupci√≥n v√≠a Hardware en dicha API.

![Image 3](/assets/img/posts/vmprotect-2022/img02_03.png)
<p style="text-align:center;margin-top: -30px;">Breakpoint de Hardware en la API `ZwProtectVirtualMemory`</p> 
 
De esta forma, comienza el proceso de desempaquetado durante el cual, el binario necesita establecer con permisos de escritura cada una de las secciones, eliminar el permiso de copia y restaurar los permisos originales. Por tanto, se debe alcanzar el break point de la API `ZwProtectVirtualMemory` todas estas veces hasta que los permisos sean los iniciales. 
 
![Image 4](/assets/img/posts/vmprotect-2022/img02_04.png)
<p style="text-align:center;margin-top: -30px;">Estado de los permisos de las secciones del binario analizado</p> 
 
Una vez realizado este proceso, siempre y cuando no se hayan aplicado protecciones adicionales, el c√≥digo original del programa puede ser encontrado en memoria dentro de la secci√≥n .text. Por lo tanto, a partir de aqu√≠ se podr√≠a volcar al disco el binario mediante cualquier herramienta que permita obtener un volcado, como por ejemplo, Scylla. No obstante, a√∫n queda la √∫ltima tarea previa a este paso: encontrar la direcci√≥n del Entry Point original (OEP). 
 
Dado que el c√≥digo de la rutina de desempaquetado se encuentra protegido mediante virtualizaci√≥n, lo m√°s sencillo para tratar de dar con el OEP es eliminar los puntos de interrupci√≥n anteriores y establecer, ahora, un punto de interrupci√≥n en la secci√≥n de memoria .text dado que el OEP deber√≠a ser la primera instrucci√≥n ejecutada. 
 
![Image 5](/assets/img/posts/vmprotect-2022/img03_05.jpg)
<p style="text-align:center;margin-top: -30px;">Entry Point del programa original vs OEP en el protegido</p> 
 
Adicionalmente al empaquetado, VMProtect incorpora una opci√≥n que permite ofuscar la tabla de funciones importadas por el programa. 

![Image 6](/assets/img/posts/vmprotect-2022/img03_06.png)
<p style="text-align:center;margin-top: -30px;">Opci√≥n que permite proteger la tabla de importaciones del binario en VMProtect</p> 
 
Tras aplicar dicha protecci√≥n, el binario generado sigue conservando funciones importadas, quiz√°s para evitar tener que importar las librer√≠as v√≠a API con LoadLibrary. No obstante, √©stas ya no son utilizadas directamente y no es posible seguir su uso en el  programa de forma est√°tica dado que las direcciones reales ahora son calculadas en tiempo de ejecuci√≥n. 
 
Al activar la opci√≥n de protecci√≥n, cada llamada a una API en la secci√≥n .text que deber√≠a tener la forma "`call <API>`" y ocupar 6 Bytes es sustituida por un ‚Äúpush + call‚Äù del mismo tama√±o. Esta nueva funci√≥n que es llamada con la instrucci√≥n call recibe me diante la instrucci√≥n push un valor aparentemente aleatorio y se utiliza una funci√≥n diferente por cada API que haya sido sustituida. 
 
Por tanto, para poder recuperar las direcciones que deber√≠a contener la tabla de 
importaciones es necesario realizar dichos c√°lculos en base al binario protegido. No obstante, √©ste proceso ya ha sido automatizado mediante diferentes herramientas como por ejemplo <a href="https://github.com/0xnobody/vmpdump">VMPDump</a>. 

![Image 7](/assets/img/posts/vmprotect-2022/img04_07.jpg)
<p style="text-align:center;margin-top: -30px;">Proceso de reconstrucci√≥n de imports en el ransomware Night Sky protegido por VMProtect</p> 

Como se ha podido observar, pese a que VMProtect es un software de protecci√≥n que destaca por caracter√≠sticas como la visualizaci√≥n y la mutaci√≥n de c√≥digo ensamblador, √©stas opciones deben ser configuradas expl√≠citamente a la hora de proteger el binario y, en algunos casos, √©stas protecciones no son aplicadas, trat√°ndose as√≠ de un simple empaquetador del que podemos llegar a extraer el c√≥digo original. 