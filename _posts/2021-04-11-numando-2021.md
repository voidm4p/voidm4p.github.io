---
layout: post
title: 游쀯릖 Investigation of the trojan Numando
author: voidm4p
date: 2021-04-11 09:00:00
categories:
- malware
tags:
- numando
- windows
- delphi
toc: true
---
# Investigaci칩n del troyano Numando 
 
***Numando*** es un troyano bancario en activo desde 2018 descubierto y bautizado por los investigadores de la compa침칤a ESET y que se suma a la lista de familias de este tipo procedentes de latinoam칠rica junto a *Guildma*, *Javali*, *Melcoz*, *Grandoreiro*, *Mekotio*, *Casbaneiro* o *Janeiro*, entre otros, aunque con mucha menos actividad que estos. 
 
Aunque reutiliza secciones de c칩digo vistas anteriormente tambi칠n en dichas familias, tambi칠n incorpora algunas funcionalidades y peculiaridades interesantes, como aprovecharse de la estructura de ficheros comprimidos de tipo ZIP o im치genes BPM para ocultar informaci칩n o el uso de sitios web p칰blicos como Youtube para almacenar la informaci칩n de sus servidores de mando y control (C2). 
 
Su principal 치rea de actividad se centra en Brasil, aunque tambi칠n se han detectado 
campa침as en M칠xico y Espa침a. El principal objetivo de esta investigaci칩n es ampliar la informaci칩n compartida por ESET y tratar de trazar patrones que permitan localizar nuevas campa침as de esta familia. 

## Flujos de infecci칩n y relaci칩n entre las muestras 
Muestras de Numando compartidas por ESET: 

| Nombre    | SHA1                                     | Tipo                                               | Firma ESET                        |
| --------- | ---------------------------------------- | -------------------------------------------------  | --------------------------------- |
| muestra 1 | e69e69fbf438f898729e0d99ef772814f7571728 | MSI downloader del "decoy ZIP"                     | Win32/TrojanDownloader.Delf.CQR   |
| muestra 2 | 4a1c48064167fc4ad5d943a54a34785b3682da92 | Instalador MSI                                     | Win32/Spy.Numando.BA              |
| muestra 3 | bb2bbca6ca318ac0abba3cd53d097fa13db85ed0 | Numando                                            | Win32/Spy.Numando.E               |
| muestra 4 | bfda3eaab63e23802ea226c6a8a50359fe379e75 | Numando                                            | Win32/Spy.Numando.AL              |
| muestra 5 | 9a7a192b67895f63f1afdf5adf7ba2d195a17d80 | Numando                                            | Win32/Spy.Numando.AO              |
| muestra 6 | 7789c57dcc3520d714ec7ca03d00ffe92a06001a | DLL con im치genes para la superposici칩n de ventanas | Win32/Spy.Numando.P               |


La muestra 4 no es localizada inicialmente en ninguna fuente de inteligencia p칰blica, por lo que se desconoce a priori su funci칩n. Sin embargo, m치s adelante se descubre ser otra librer칤a DLL principal de *Numando* proveniente de una de las URL de descarga. Tras el descubrimiento, es subida a la plataforma VirusTotal para que pueda localizarse de forma p칰blica. 
 
Por otra parte, el malware  utiliza aplicaciones leg칤timas para cargarse en memoria en forma de librer칤a DLL. Algunas de las aplicaciones leg칤timas utilizadas son: 
 
| Nombre                | SHA1                                     | DLL de Numando cargada |
| --------------------- | ---------------------------------------- | ---------------------- |
| Aplicaci칩n leg칤tima 1 | a852a99e2982df75842ccfc274ea3f9c54d22859 | nvsmartmax.dll         |
| Aplicaci칩n leg칤tima 2 | f804db94139b2e1d1d6a3cd27a9e78634540f87c | mpr.dll                |
| Aplicaci칩n leg칤tima 3 | 65684b3d962fb3483766f9e4a9c047c0e27f055e | Oleacc.dll             |
 
 
Para comprender c칩mo se relacionan todas estas muestras se procede a analizar el flujo de infecci칩n descrito por los investigadores donde indican haber observado diferentes tipos de cadenas de distribuci칩n. 
 
Destacan un primer flujo que comienza con ficheros como el de la **muestra 1**. Esta es un instalador Windows de tipo MSI que contiene en su interior diferentes ficheros binarios entre los que se encuentran dos librer칤as DLL, una llamada *aicustact.dll*, que es una librer칤a leg칤tima para detectar cualquier conexi칩n a Internet disponible y, otra llamada *ESCOLA.dll*, que es el *downloader*.

![Image 1](/assets/img/posts/numando-2021/img02_01.png)

La funci칩n hash SHA1 de *ESCOLA.dll* es: 313fbffa0be37eaf62199ddc7e0217b6e855b077  
 
Esta librer칤a est치 programada en Delphi, un lenguaje de programaci칩n t칤picamente utilizado tambi칠n por los actores detr치s de otros troyanos bancarios latinoamericanos. La librer칤a contiene una funci칩n exportada llamada "*ESPORTE*" que realiza la funci칩n principal de descarga.

![Image 2](/assets/img/posts/numando-2021/img03_02.png)
 
Tras acceder al c칩digo de esta funci칩n, se observa una cadena de caracteres que se encuentra ofuscada.

![Image 3](/assets/img/posts/numando-2021/img03_03.png)
  
Esta cadena es descifrada en tiempo de ejecuci칩n por la funci칩n *sub_608324*. 

![Image 4](/assets/img/posts/numando-2021/img04_04.jpg)

Analizando el c칩digo de 칠sta, se puede implementar el algoritmo de descifrado utilizado mediante el lenguaje Python. 

```python
string = 
"Q33646600K37528900B37528900M36234800O37205375G18764450S15205675P15205675J35264225A32676025E38823000R32028975G14882150G37205375Y16499775I14882150R37852425Y37205375C14558625X32676025L31381925V37205375D37528900G14558625M16176250R14882150V31381925W35264225J31381925X39470050M35911275K35587750Y31381925M38499475B37205375J14882150C32028975G35911275P35264225S15205675I37205375A37852425N32028975T32676025H37205375H37205375M32999550X37852425P34940700R34940700B39146525G14882150R39470050U33970125L36234800G" 
caps = False 
result = "" 
partial_result = "" 
for index in range(0, len(string)): 
    if caps: 
        character = string[index] 
        if character < 'A' or character > 'Z': 
            partial_result += character 
        else: 
            caps = False 
            result += chr(int(partial_result) / 323525) 
            partial_result = "" 
    character = string[index] 
    if character >= 'A' and character <= 'Z': 
        caps = True 
print(result) 
```

Tras ejecutar el script se obtiene la URL de descarga utilizada por el downloader:

```
hxxps://mexc[.]s3[.]us-east-2[.]amazonaws[.]com/sucessfully[.]zip 
```

Desde esa URL se descarga el fichero *sucessfully.zip* cuya funci칩n hash SHA1 es 1cc1b75dc28261eebcf40777ebf3af750c19b1fc.  
 
Este fichero ZIP es procesado por el *downloader* que, en lugar de tratarlo como un fichero comprimido, accede a 칠l para buscar el primer car치cter "\{" empezando por el final, que es un car치cter utilizado como delimitador. A partir de aqu칤, extrae una cadena de caracteres que es descifrada utilizando el mismo algoritmo anterior para obtener una nueva URL de descarga. 

![Image 5](/assets/img/posts/numando-2021/img05_05.png)

La nueva URL es `hxxps://mexc[.]s3[.]us-east-2[.]amazonaws[.]com/mexc[.]zip` desde la cual se descarga otro fichero ZIP comprimido cuya funci칩n HASH SHA1 es 5d14fe4d43a6a6a77e788b029131268c0199df4. 
 
Esta vez el fichero si es descomprimido y en su interior se encuentran otros tres ficheros: un binario llamado svchost.exe y dos librer칤as llamadas x86.dll y NVSMARTMAX.dll. Las funciones HASH de estos ficheros son: 
 
| bb2bbca6ca318ac0abba3cd53d097fa13db85ed0 | NVSMARTMAX.dll | **muestra 3**                   |
| a852a99e2982df75842ccfc274ea3f9c54d22859 | svchost.exe    | **Aplicaci칩n leg칤tima 1**       |
| 4b08ba3d1cc01638fafa49fd69b43e52d041b516 | x86.dll        | DLL utilizada por muestra 3 |
 
La **muestra 2** representa otro flujo de infecci칩n similar: un instalador MSI que,  en este caso, no se trata de un *downloader* ya que incluye al malware en su interior directamente. Extrayendo los ficheros que contiene el instalador, se encuentran diferentes binarios. 

![Image 6](/assets/img/posts/numando-2021/img06_06.png)

Tanto *libeay32.dll* como *ssleay32.dll* son librer칤as leg칤timas pertenecientes a OpenSSL, como tambi칠n lo es *Cooperativa.exe*, que se trata de la ***aplicaci칩n leg칤tima 3***. Este binario carga la librer칤a DLL maliciosa *Oleacc.dll*, la cual se encarga de descifrar mediante un simple XOR el fichero *Oleacc*. La librer칤a incluye informaci칩n de depuraci칩n por lo que se pueden observar los nombres de las funciones creadas por los desarrolladores del descifrador.

![Image 7](/assets/img/posts/numando-2021/img06_07.png)
 
Una vez descifrado con la clave XOR "99871818", se obtiene la librer칤a DLL de Numando cuya funci칩n hash SHA1 es 967aed040fabdb5645fc13a82df2c60d5efcdf3 
 
La ***muestra 5*** es otra librer칤a DLL como la anterior pero, en este caso, se encuentra empaquetada con el software de protecci칩n **Themida**. Por otra parte, la ***muestra 6***, es una DLL como la *x86.dll* vista anteriormente que contiene im치genes utilizadas por la librer칤a DLL principal de Numando. 

## URL de descarga adicionales 
Desde ESET comparten URL de descarga de ficheros ZIP de Numando adicionales. Dado que en el momento del an치lisis dichas direcciones han sido deshabilitadas, se utiliza la plataforma VirusTotal para acceder a los ficheros descargados en su momento desde ah칤. 
 
| URL | SHA1 ZIP | Clave XOR | SHA1 DLL |
| --- | -------- | --------- | -------- |
| hxxps://enjoyds[.]s3[.]us-east-2[.]amazonaws[.]com/H97FJNGD86R[.]zip | a18328daae06739c0c61b8fe41860c3bf2eeda9a | 31369 | bfda3eaab63e23802ea226c6a8a50359fe379e75 |
| hxxps://lksluthe[.]s3[.]us-east-2[.]amazonaws[.]com/B876DRFKEED[.]zip | ab861a48636561c5eeb81f75fd9d33fc18484096 | 84192 | 5412e926c90ea77073dc340b2c328bbaaa1e2f07 |
| hxxps://procjdcals[.]s3[.]us-east-2[.]amazonaws[.]com/HN97YTYDFH[.]zip | 3dac71830be3f871e11631922b25df0ea9be77f5 | 52155 | 25b731cf9f9eee3349ff4640fe5c89ff16069276 |
| hxxps://rmber[.]s3[.]ap-southeast-2[.]amazonaws[.]com/B97TDKHJBS[.]zip | d7bc949b4d314322865637e292027c9ec23fe304 | 80416 | 9620a7cea45fe05e88e07c78d1b80ee4d65633ac |
| hxxps://sucessmaker[.]s3[.]us-east-2[.]amazonaws[.]com/JKGHFD9807Y[.]zip | ebaaf3bbded48f1860db0e4d99e122f2008ad0b3 | 29765 | 412b2de4e98f7be03fc7e902788ab4e550b6ca58 |
| hxxps://trbnjust[.]s3[.]us-east-2[.]amazonaws[.]com/B97T908ENLK[.]zip | 85a4aec2d57fc81565bb8c22b6ea6c12a7a69451 | 76410 | b9798bed8d59b495ebaec32ed16cb527d1391270 |
| hxxps://webstrage[.]s3[.]us-east-2[.]amazonaws[.]com/G497TG7UDF[.]zip | - | - | - |

La primera de las librer칤as DLL descifradas resulta ser la ***muestra 4*** que, a priori, no pudo ser localizada en ninguna fuente de inteligencia p칰blica. 

## Numando 
Al igual que el resto de familias de troyanos latinoamericanos mencionadas, *Numando* est치 programado utilizando el lenguaje **Delphi**. Para analizar las capacidades del troyano se toma como referencia la ***muestra 3*** que incluye informaci칩n de depuraci칩n y permite identificar los nombres de las funciones utilizados por los desarrolladores del troyano y, por tanto, identificar m치s f치cilmente su funcionalidad. 
 
Las cadenas de caracteres del binario est치n cifradas mediante un algoritmo utilizado tambi칠n en otras familias. El origen de este algoritmo es el libro titulado "*Mestres da Espionagem Digital*". Dichas cadenas tienen forma de cadena hexadecimal pero en may칰sculas, es decir, d칤gitos entre el 0 y el 9 y letras entre la A y la F. La clave de cifrado tiene un formato similar pero, en su caso, puede contener d칤gitos entre el 0 y el 9 y letras entre la A y la Z.

![Image 8](/assets/img/posts/numando-2021/img08_08.png)
 
La funci칩n `Ucrypt::DC` es la encargada de descifrar las cadenas. Para ello, el algoritmo utiliza instrucciones XOR y SUB. Comienza almacenando los dos primeros bytes de la cadena cifrada en una variable y los dos siguientes en otra. 
 
Por ejemplo, para la cadena de la imagen, la primera variable valdr칤a 0xBB y la segunda 0xBD. Mediante la primera se realiza la operaci칩n sub a partir del resultado obtenido de realizar un XOR con la segunda y el primero de los bytes de la clave. Tras esto , el resultado se convierte a ASCII y se almacena en una nueva variable moviendo el 칤ndice adelante en dos posiciones. En la siguiente iteraci칩n la primera variable toma el valor que previamente ten칤a la segunda y la segunda toma el siguiente par de caracteres de la cadena cifrada y as칤 sucesivamente, realizando tantas iteraciones como pares de caracteres tenga la cadena. 
 
El siguiente c칩digo python equivale al algoritmo de cifrado utilizado: 
 
```python
def DecodeString(encodedString, key): 
    decodedString = [] 
    if encodedString: 
        keyLen = len(key) 
        encStrLen = len(encodedString) 
        prevEncodedByte = 0 
        encStrList = [] 
        keyList = [] 
      
        encodedString = [encodedString[i:i+2] for i in range(0, encStrLen, 2)] 
        for byte in encodedString: 
            encStrList.append(int(byte, 16)) 
      
        key = [key[i] for i in range(0, keyLen, 1)] 
        for byte in key: 
            keyList.append(ord(byte)) 
      
        prevEncodedByte = encStrList[0] 
      
        encStrLen = len(encStrList) 
        keyLen = len(keyList) 
        keyOffset = 0 
      
        for i in range(1,encStrLen): 
            if(keyOffset>=keyLen): 
                keyOffset = 0 
            decodedByte = encStrList[i] ^ keyList[keyOffset] 
            if(decodedByte>prevEncodedByte): 


                decodedByte -= prevEncodedByte 
            else: 
                decodedByte = decodedByte + 0xFF - prevEncodedByte 
            prevEncodedByte = encStrList[i] 
            decodedString.append(chr(decodedByte)) 
      
            keyOffset += 1 
  
    return("".join(decodedString)) 
```

La clave de cifrado se encuentra dentro de la funci칩n de descifrado de cadenas, parece tener siempre una longitud de 250 caracteres y se encuentra almacenada como cadena de tipo Unicode. Para que la herramienta IDA la identifique, hay que forzarlo. 
 
- Antes:
![Image 9](/assets/img/posts/numando-2021/img09_09.png)

- Despu칠s: 
![Image 10](/assets/img/posts/numando-2021/img09_10.png)

La clave de cifrado utilizada en esta muestra es:  

```
CR358ACDGJLMORUX1357ACEGJLNOSUVZ35UX2467BEGJLNPRU2468BDGILNPSUX2479CFIKMORTVZ358BDGIKNPRV1469BEGKNPSV146ADFILOQUZ369CFILX258BEHJORU147ADHLORUZ47BFILPSV25ADHKNRU148CFJMQU269DHKOSX37AEILRV159DHLPTZ48CGLQU159DINRV26BFJNSZ49DIMQU27BGKPTAFJNTZ59EINSZ59EIO 
```

Mediante la siguiente l칩gica es posible localizar la clave de la muestra a analizar: 
 
```python
import sys 
from Strings import Strings 

def is_key(string): 
    val = True 
    for c in string: 
        char = ord(c) 
        if (char < ord('0') or char > ord('9')) and (char < ord('A') or char > ord('Z')): 
            val = False 
            break 
    return val 
 
def search_key(filepath): 
    possible_keys = set() 
    strings = Strings(filepath) 
    for cpStr in strings.extract_unicode_strings(): 
        if is_key(cpStr) and len(cpStr)==250:  # la clave tiene logitud 250 
            possible_keys.add(cpStr) 
    return list(possible_keys) 
 
filepath = sys.argv[1] 
possible_keys = search_key(filepath) 
if len(possible_keys) == 1: 
    key = possible_keys[0] 
    print("[+] Key found: {}".format(key)) 
```

*Numando* act칰a creando ventanas falsas que incitan al usuario a que introduzca sus datos bancarios. Para ello, monitoriza la navegaci칩n del usuario en b칰squeda de ciertos t칤tulos de p치gina que contiene en sus cadenas cifradas. Tras descifrarlas, se obtiene el list ado de entidades bancarias a las que afecta esta muestra.

![Image 11](/assets/img/posts/numando-2021/img10_11.png)

```  
Banco Bci 
Banco de Chile 
Banco Estado 
Banco Security 
Banco Azteca 
HSBC 
Banco Santander 
BICE 
Banco Falabella 
Scotiabank 
Bradesco 
Banco Condell 
Banco Internacional 
Banco Ita칰 
Banco Ripley 
BBVA M칠xico 
Scotiabank Azul 
El Banco Fuerte de M칠xico 
Santander M칠xico 
Banco Mercantil 
Banestes 
Banese 
Banrisul 
```

En algunas muestras, las im치genes necesarias para llevar a cabo la suplantaci칩n se almacenan en un archivo ZIP cifrado dentro de la secci칩n de recursos del binario, mientras que otras utilizan una librer칤a DLL adicional para ello como las vistas anteriorme nte. En el caso de la muestra analizada, hace uso de la librer칤a DLL *x86.dll* vista anteriormente, llamando a la funci칩n exportada "*ADJUSTE*" e indicando la imagen a extraer mediante un 칤ndice num칠rico.

![Image 12](/assets/img/posts/numando-2021/img11_12.png)
 
En funci칩n de la imagen seleccionada, se mostrar치 una ventana con la informaci칩n del banco en cuesti칩n para tratar que el usuario introduzca sus datos de acceso. 

![Image 13](/assets/img/posts/numando-2021/img12_13.png)

El troyano adem치s incluye funcionalidades de puerta trasera que les permite a los atacantes realizar diferentes tareas bajo demanda. Estas opciones son manejadas mediante un gran bloque de instrucciones de tipo *switch-case*.

![Image 14](/assets/img/posts/numando-2021/img12_14.png)
 
Algunas de las funcionalidades incluyen: 
- Capturar el movimiento de rat칩n y pulsaci칩n de teclado

![Image 15](/assets/img/posts/numando-2021/img13_15.jpg)

- Capturar la pantalla mediante la librer칤a "*Magnification.dll*".

![Image 16](/assets/img/posts/numando-2021/img13_16.png)

- Apagar o reiniciar el equipo:

![Image 17](/assets/img/posts/numando-2021/img14_17.jpg)

- Recopilaci칩n de informaci칩n del Sistema Operativo:

![Image 18](/assets/img/posts/numando-2021/img14_18.png)

- Auto-borrado autom치tico:

![Image 19](/assets/img/posts/numando-2021/img14_19.png)

Para comunicarse con sus servidores C2, el troyano hace uso de una sintaxis similar a la del resto de familias pero, en este caso, los comandos que puede recibir son especificados mediante n칰meros en lugar de cadenas de caracteres, seguramente para evitar detecciones a nivel de red. Esta utilizaci칩n de n칰meros para los comandos es el motivo del nombre del troyano *Numando*.

![Image 20](/assets/img/posts/numando-2021/img15_20.png)

En esta muestra, la direcci칩n del C2 se encuentra escrita en el propio binario.

![Image 21](/assets/img/posts/numando-2021/img15_21.png)
 
Sin embargo, en otras muestras se incluye una URL a sitios web p칰blicos como YouTube o Pastebin en los que se almacena cifrada la IP y puerto del servidor C2.

![Image 22](/assets/img/posts/numando-2021/img15_22.jpg)

Por 칰ltimo, para establecer persistencia, el malware renombra el binario leg칤timo que lo ha lanzado con una extensi칩n nueva. En el caso de la muestra analizada: .scr.

![Image 23](/assets/img/posts/numando-2021/img16_23.png)
 
Una vez renombrado crea un acceso directo (.lnk) en la ruta de Startup para que se inicie con el sistema.

![Image 24](/assets/img/posts/numando-2021/img16_24.png)
 
## Referencias 
- <a href="https://www.welivesecurity.com/la-es/2021/09/17/numando-nuevo-troyano-busca-datos-bancarios-afecta-brasil/" target="_blank">https://www.welivesecurity.com/la-es/2021/09/17/numando-nuevo-troyano-busca-datos-bancarios-afecta-brasil/</a>  
- <a href="https://www.basquecybersecurity.eus/archivos/202109/bcsc-malware-mekotio-tlpwhite816.pdf?1">https://www.basquecybersecurity.eus/archivos/202109/bcsc-malware-mekotio-tlpwhite816.pdf?1</a>  

## IOC 
```
e69e69fbf438f898729e0d99ef772814f7571728 
4a1c48064167fc4ad5d943a54a34785b3682da92 
bb2bbca6ca318ac0abba3cd53d097fa13db85ed0 
bfda3eaab63e23802ea226c6a8a50359fe379e75 
9a7a192b67895f63f1afdf5adf7ba2d195a17d80 
7789c57dcc3520d714ec7ca03d00ffe92a06001a 
313fbffa0be37eaf62199ddc7e0217b6e855b077 
1cc1b75dc28261eebcf40777ebf3af750c19b1fc 
4b08ba3d1cc01638fafa49fd69b43e52d041b516 
bfda3eaab63e23802ea226c6a8a50359fe379e75 
5412e926c90ea77073dc340b2c328bbaaa1e2f07 
25b731cf9f9eee3349ff4640fe5c89ff16069276 
9620a7cea45fe05e88e07c78d1b80ee4d65633ac 
412b2de4e98f7be03fc7e902788ab4e550b6ca58 
b9798bed8d59b495ebaec32ed16cb527d1391270 
```
